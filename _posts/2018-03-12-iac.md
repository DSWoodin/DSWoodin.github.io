---
layout: post
title: IaC com Troposphere e boto3
subtitle: Subindo uma infra na aws utilizando CloudFormation
date: 2018-03-12 21:00:00
image: /img/big-bang.jpg
share-img: /img/big-bang.jpg
tags: iac, devops, infragil, ferramentas
categories: iac
---

Hoje a criação de uma infra ágil é indispensável, pois assim aquela release que antes demorava 1 semana para ir pro ar, pode demorar alguns minutos. Neste post vamos subir uma simples configuração de infraestrutura na aws utilizando o troposphere, boto3 e o cloduformation, onde toda a infraestrutura estar em código  ou IaC(Infra as code).  

## Conhechendo as ferramentas

### Troposphere  
[Troposphere](https://github.com/cloudtools/troposphere) é uma ferramenta opensource, escrita em python, onde v cria um template para ser "inserido" no clodformation. O propio repositorio do troposphere tem alguns exemplos, bem simples de como utilizar.

### Boto3  

[Boto3](http://boto3.readthedocs.io/en/latest/index.html) é um SDK da aws para interagir entra seus scripts e os serviços da aws. Ele possue uma vassta documentação com inumeros serviçs que pode ser utilizados. Neste artigo iremos utilizar o componente [create_stack](http://boto3.readthedocs.io/en/latest/reference/services/cloudformation.html?highlight=create_stack#CloudFormation.Client.create_stack).


### CloudFormation  
O [CloudFormation](https://aws.amazon.com/cloudformation/) é uma das inumeras serviços da aws,com este serviço você consegue descrever todos os recursos da aws(vale salientar que o clodformation é free).


Mãos ao código...

Vamos criar uma infra com um Ec2+ELB+autoscaling, nada muito complexo, mas que ja ajudara a compreender o funcionamento das ferramentas.

Vale lembrar que estou utilizando o Debian 9

**1 - Criação do ambiente**  
Sempre é bom você ter ambientes isolados para seus projetos, com isso um modulo não ingluencia no outro. Uma boa dia é utilizar o virtualenv, assim os projetos em python ficam isolados um dos outros.

```
$ apt-get install python-virtualenv
mkdir iac
cd iac
virtualenv -p python3 venv
source venv/bin/activate
```

Bom nesse trecho de codigo eu instalo o virtualenv(caso eu não tenha), após isso crio uma pasta para o projeto e depois instalo os pacotesz do virtualenv.

Com o comando `$ source venv/bin/activate` eu inicializo o virtualenv e isolo meu ambiente, assim todos os pacotes que eu instalar agora, ficaram nesse ambiente. Caso queira sair, basta digitar `deactivate`.

**2 - Instalação de pacotes**

Sera necessario a instalação de alguns pacotes...

```
$ pip install awscli  
$ pip install troposphere   
$ pip install boto3
```

Após a instalação sera necessario adicionar as credencias da aws, digite:

```
aws configure
```

Lembrese, caso vc tem mais projetos na sua maquina, voce podeter mais de uma configuração da aws, por exemplo nesse, precisamos de um usuario com acesso a ec2, loadbalance e autoscaling.

**3 - Criando seu primeiro Ec2**
Agora vamos criar um arquivo chamado `exemplo1.py`, onde iremos criar primeiramente um ec2, para ver como funciona as ferramentas. Neste exemplo estarei usando a regiao *us-east-1*. Vale lembra que cada região tem sua AMI propia, ou seja o ID de uma AMI não vale para outra regiao. [Aqui](https://cloud-images.ubuntu.com/locator/ec2/) você pode ver todos os IDs das amis do ubuntu. Bom, vamos la...

exemplo.py
```
from troposphere import Template
from troposphere.ec2 import Instance

def ec2():
    return Instance(
        "ec2",
        ImageId='ami-43a15f3e',
        InstanceType="t1.micro",
        KeyName='keyTeste',
        SecurityGroups=["default"]
    )

def template():
    t = Template()
    t.add_resource(ec2())
    return t


if __name__ == '__main__':

    print(template().to_json())
```

Salve e execute `$ python exemplo.py` e a saida no terminal sera algo como:

![exemplo](/img/troposphere1.png)

Como podemos ver o troposphere criou um template que vc pode adicionar manualmente no clodformation, porem agora vamos editar esse aquivo e adicionat o boto3, para que ele crie essa stack no CloudFormation.
