---
layout: post
title: Windows 10 Overlay for Unified Write Filter (UWF)
date: '2017-09-21T02:07:00.000-07:00'
author: syswow64
tags:
- Deepfreeze
- MDT
- UWF
- Feature Roles
- Windows 10
- Unified Write Filter
modified_time: '2020-01-17T04:20:27.049-08:00'
thumbnail: https://3.bp.blogspot.com/-rDTW7dBE-9o/WcN8d0lxdfI/AAAAAAAABUo/xySatZQ0lVoZ5zhUy9M_XGpI5ynuTqo1gCLcBGAs/s72-c/MDT-OSFeatureStep.png
blogger_id: tag:blogger.com,1999:blog-4452544758446808584.post-549867543575579393
blogger_orig_url: https://www.syswow64.co.uk/2017/09/windows-10-overlay-for-unified-write.html
---

<h2>Windows 10 Overlay for Unified Write Filter (UWF)</h2><br />This entry is to document my experience with the Windows 10 feature Unified Write Filter (UWF); with the intention to replace DeepFreeze on shared computers.<br /><br />"Unified Write Filter (UWF) protects the contents of a volume by redirecting all write operations on that volume to the overlay, which is a virtual representation of the changes to the volume. Conceptually, an overlay is similar to a transparency overlay on an overhead projector. Any change that is made to the transparency overlay affects the projected picture as it is seen by the viewer. However, if the transparency overlay is removed, the underlying picture remains unchanged.<br />In a UWF protected system, UWF creates a single overlay, which contains information about writes to all protected volumes on a system. The overlay supports up to 16 terabytes of protected volumes."<br /><b>(extract from&nbsp;<a href="https://docs.microsoft.com/en-us/windows-hardware/customize/enterprise/uwfoverlay" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/customize/enterprise/uwfoverlay</a>)&nbsp;</b><br /><b><br /></b><b>How to install the UWF&nbsp;</b><b>feature&nbsp;</b><b>?</b><br /><b><br /></b>The Windows 10 feature can be installed in several ways; the offline Wim file via DISM, PowerShell, Manually via Control Panel GUI, Provisioning package or WMI. All methods are detailed <a href="https://docs.microsoft.com/en-us/windows-hardware/customize/enterprise/unified-write-filter" target="_blank">here</a>.<br /><br /><b>PowerShell Method</b><br />Enable-WindowsOptionalFeature -Online -FeatureName "Client-UnifiedWriteFilter" -All #NoRestart<br /><br /><b>SCCM and MDT Method</b><br />If you use the SCCM with the MDT this OS Feature can be enabled during the Task Sequence with the step "Install Roles and Features".<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-rDTW7dBE-9o/WcN8d0lxdfI/AAAAAAAABUo/xySatZQ0lVoZ5zhUy9M_XGpI5ynuTqo1gCLcBGAs/s1600/MDT-OSFeatureStep.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="635" data-original-width="701" height="362" src="https://3.bp.blogspot.com/-rDTW7dBE-9o/WcN8d0lxdfI/AAAAAAAABUo/xySatZQ0lVoZ5zhUy9M_XGpI5ynuTqo1gCLcBGAs/s400/MDT-OSFeatureStep.png" width="400" /></a></div><br /><br />This can be taken further and applied to an MDT Database Role that is "Gathered" during the task sequence; far more dynamic and less steps/logic involved within the Task Sequence.<br /><br />The ID for each Role and Feature can be found in the ServerManager.xml file located within the Microsoft Deployment Toolkit folder.<br /><b>C:\Program Files\Microsoft Deployment Toolkit\Bin\ServerManager.xml)</b><br /><b><br /></b>Exactly like the PowerShell Feature name you will find the ID "Client-UnifiedWriteFilter" within this XML. This ID can be added to the MDT Database under the OS Roles&gt; OSFeatures. &nbsp;If you need to apply multiple Features simply separate the ID's with the use of commas. The end result will provision Windows 10 with the UWF feature installed.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-W2R5aamPM94/WcN79S9KWzI/AAAAAAAABUg/4pIPH4zdIJsxOFU1nFFZjj-dzptuoExAACLcBGAs/s1600/MDT-OSFeature.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="141" data-original-width="462" src="https://4.bp.blogspot.com/-W2R5aamPM94/WcN79S9KWzI/AAAAAAAABUg/4pIPH4zdIJsxOFU1nFFZjj-dzptuoExAACLcBGAs/s1600/MDT-OSFeature.png" /></a></div><br /><br /><b><br /></b><b><br /></b><b><br /></b><b><br /></b><b><br /></b><b><br /></b><b><br /></b><b>NOTE: The UWF feature must be installed prior to the SCCM client being installed.</b><br /><span style="background-color: #fcf8e3; color: #8a6d3b; font-family: , &quot;segoe ui&quot; , &quot;segoe&quot; , &quot;segoe wp&quot; , &quot;helvetica neue&quot; , &quot;helvetica&quot; , sans-serif; font-size: 14px;">For Windows 10 computers that you plan to protect with Unified Write Filter (UWF), you must configure the device for UWF before you install the client. This enables Configuration Manager to install the client with a custom credential provider that locks out low-rights users from logging in to the device during maintenance mode.</span><br /><span style="background-color: #fcf8e3; font-size: 14px;"><span style="color: #8a6d3b; font-family: , &quot;segoe ui&quot; , &quot;segoe&quot; , &quot;segoe wp&quot; , &quot;helvetica neue&quot; , &quot;helvetica&quot; , sans-serif;"><a href="https://docs.microsoft.com/en-us/sccm/core/clients/deploy/plan/best-practices-for-client-deployment" target="_blank">https://docs.microsoft.com/en-us/sccm/core/clients/deploy/plan/best-practices-for-client-deployment</a></span></span><br /><br /><br /><b>How to Enable the UWF feature ?</b><br /><b><br /></b>After the Feature is installed and the computer rebooted there will be a utility called "uwfmgr" within the System32 folder. To enable the feature on the command line, call this utility with the following commands.<br /><br />uwfmgr filter enable<br />uwfmgr volume protect c:<br /><br />Through trial and error we have established a list of file, folder, and Registry Exclusions that should be exempt from UWF to maintain GPO, logs, and SCCM activity.<br /><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Microsoft System Center"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm\UserAffinityStore.sdf"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm\InventoryStore.sdf"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm\CcmStore.sdf"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm\StateMessageStore.sdf"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm\CertEnrollmentStore.sdf"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccm\ServiceData"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccmssetup"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\ccmcache"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\_TaskSequence"</span><br /><span style="font-size: x-small;"><strike>uwfmgr file add-exclusion "c:\windows\bootstat.dat"&nbsp;</strike>&nbsp;This caused a Boot failure in Windows 1709</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\Windows\wlansvc\Policies"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramData\Microsoft\wlansvc\Profiles\Interfaces"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramData\Microsoft\dot3svc\Profiles\Interfaces"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\Windows\dot2svc\Policies"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\Program Files\Windows Defender"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramFiles(X86)\Windows Defender"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramData\Microsoft\Windows Defender"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\Windows\WindowsUpdate.log"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\Windows\Temp\MpCmdRun.log"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramData\Microsoft\Windows Defender"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\Windows\System32\Microsoft\Protect"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\ProgramData\Microsoft\Crypto"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\Software\Microsoft\SystemCertificates\SMS\Certificates"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Antimalware"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\BITS\StateIndex"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\dot3svc"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Time Zones"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CCM\StateSystem"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WiredL2\GP_Policy"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Wireless\GPTWirelessPolicy"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Wlansvc"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\WwanSvc"</span><br /><span style="font-size: x-small;">uwfmgr registry add-exclusion "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\dot3svc"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "C:\ProgramData\Microsoft\Network\Downloader"</span><br /><span style="font-size: x-small;">uwfmgr file add-exclusion "c:\windows\System32\Winevt\Logs"</span><br /><span style="font-size: x-small;"><br /></span><span style="font-size: x-small;"><br /></span>Source reference &nbsp;for Exclusions<br /><a href="https://docs.microsoft.com/en-us/sccm/core/clients/deploy/plan/planning-for-client-deployment-to-windows-embedded-devices">https://docs.microsoft.com/en-us/sccm/core/clients/deploy/plan/planning-for-client-deployment-to-windows-embedded-devices</a><br /><b><br /></b><a href="https://deploymentresearch.com/Research/Post/632/Using-the-Unified-Write-Filter-UWF-feature-in-Windows-10" target="_blank">https://deploymentresearch.com/Research/Post/632/Using-the-Unified-Write-Filter-UWF-feature-in-Windows-10</a><br /><br /><a href="https://docs.microsoft.com/en-us/windows-hardware/customize/enterprise/uwf-antimalware-support" target="_blank">https://docs.microsoft.com/en-us/windows-hardware/customize/enterprise/uwf-antimalware-support</a><br /><br /><b>How to Service UWF enabled Windows 10 computers?</b><br /><br />SCCM is UWF aware and when Software Updates are deployed the SCCM client will reboot the system with UWF disabled, and lockout the system to non admins. &nbsp;Once the Updates are installed the system will reboot again enabling UWF.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-n6goqxIXA_c/WcOBASAd82I/AAAAAAAABU0/EKPTt5Mj_9IB-hE3XScmoJDFZNrowpnAgCLcBGAs/s1600/UWF-SUG-Deployment.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="600" data-original-width="678" src="https://1.bp.blogspot.com/-n6goqxIXA_c/WcOBASAd82I/AAAAAAAABU0/EKPTt5Mj_9IB-hE3XScmoJDFZNrowpnAgCLcBGAs/s1600/UWF-SUG-Deployment.png" /></a></div><br />The "Write Filter handling for Windows Embedded devices" when enabled will trigger the Client notification to restart with UWF disabled.<br /><br />Update: 13/03/2018<br /><br />After a while Windows 10 was producing security notifications for 'Disk Scan Errors'&nbsp; and 'Firewall disabled' toast notifications.&nbsp; I was able to suppress these toast notifications with Group Policy by setting the Key&nbsp;<span style="font-family: Calibri; font-size: 14.6667px;">Windows.SystemToast.SecurityAndMaintenance\Enable = 0</span><br /><br /><span style="font-family: Calibri; font-size: 11pt;">reg add "HKEY_LOCAL_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Notifications\Settings\Windows.SystemToast.SecurityAndMaintenance" /v Enable /t REG_DWORD /d 0 /f</span><br /><br /><br /><br /><br /><br />