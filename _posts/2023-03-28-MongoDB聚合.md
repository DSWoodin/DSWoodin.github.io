---
layout: post
title: MongoDB聚合操作
subtitle: 强大的数据处理工具
tags: [CS,Mongo]
---

MongoDB是一个非关系型数据库，它的聚合框架提供了一种强大的方式来处理数据。聚合框架允许您对数据进行分组，筛选，排序和转换，以便更好地理解和分析数据。

## 聚合管道

MongoDB聚合框架使用聚合管道来处理数据。聚合管道是一系列的阶段，每个阶段都会对数据进行处理。聚合管道的输出将成为下一个阶段的输入。聚合管道的最后一个阶段将输出最终结果。

以下是聚合管道的一些常见阶段：

### $match

$match阶段用于筛选文档。它类似于SQL中的WHERE子句。您可以使用各种条件来筛选文档，例如等于，不等于，大于，小于等等。

以下是一个$match阶段的示例：

```
db.collection.aggregate([
  { $match: { age: { $gt: 18 } } }
])
```

上面的聚合管道将筛选出年龄大于18岁的文档。

### $group

$group阶段用于对文档进行分组。它类似于SQL中的GROUP BY子句。您可以使用各种条件来分组文档，例如字段名，表达式等等。

以下是一个$group阶段的示例：

```
db.collection.aggregate([
  { $group: { _id: "$name", count: { $sum: 1 } } }
])
```

上面的聚合管道将按照名称对文档进行分组，并计算每个组中文档的数量。

### $sort

$sort阶段用于对文档进行排序。它类似于SQL中的ORDER BY子句。您可以使用各种条件来排序文档，例如字段名，表达式等等。您可以使用$sort阶段对文档进行升序或降序排序。

以下是一个$sort阶段的示例：

```
db.collection.aggregate([
  { $sort: { age: 1 } }
])
```

上面的聚合管道将按照年龄字段对文档进行升序排序。

### $project

$project阶段用于对文档进行投影。它类似于SQL中的SELECT子句。您可以使用各种条件来选择要包含在输出文档中的字段，例如字段名，表达式等等。

以下是一个$project阶段的示例：

```
db.collection.aggregate([
  { $project: { name: 1, age: 1 } }
])
```

上面的聚合管道将只包含名称和年龄字段的输出文档。

### $limit

$limit阶段用于限制输出文档的数量。它类似于SQL中的LIMIT子句。您可以使用$limit阶段来限制输出文档的数量。

以下是一个$limit阶段的示例：

```
db.collection.aggregate([
  { $limit: 10 }
])
```

上面的聚合管道将限制输出文档的数量为10个。

### $skip

$skip阶段用于跳过输出文档的数量。它类似于SQL中的OFFSET子句。您可以使用$skip阶段来跳过输出文档的数量。

以下是一个$skip阶段的示例：

```
db.collection.aggregate([
  { $skip: 10 }
])
```

上面的聚合管道将跳过前10个输出文档。

### $unwind

$unwind阶段用于展开数组字段。它将数组字段中的每个元素都展开为单独的文档。您可以使用$unwind阶段来对数组字段进行分组和聚合操作。

以下是一个$unwind阶段的示例：

```
db.collection.aggregate([
  { $unwind: "$tags" }
])
```

上面的聚合管道将展开名为“tags”的数组字段中的每个元素。

### $lookup

$lookup阶段用于在不同的集合之间执行左外连接。它类似于SQL中的JOIN操作。您可以使用$lookup阶段来将两个集合中的文档合并为一个输出文档。

以下是一个$lookup阶段的示例：

```
db.orders.aggregate([
  {
    $lookup:
      {
        from: "products",
        localField: "product_id",
        foreignField: "_id",
        as: "product"
      }
 }
])
```

上面的聚合管道将orders集合中的每个文档与products集合中的文档进行左外连接，并将结果存储在名为“product”的数组字段中。

### $out

$out阶段用于将聚合管道的输出写入到一个新的集合中。它类似于SQL中的INSERT INTO操作。您可以使用$out阶段来将聚合管道的输出写入到一个新的集合中。

以下是一个$out阶段的示例：

```
db.collection.aggregate([
  { $match: { age: { $gt: 18 } } },
  { $out: "new_collection" }
])
```

上面的聚合管道将筛选出年龄大于18岁的文档，并将结果写入到名为“new_collection”的新集合中。

### 示例

现在您已经了解了MongoDB聚合框架的一些常见阶段，可以开始使用它们来处理和分析您的数据了。

```
db.collection.aggregate([
  { $project: { name: 1, age: 1 } },
  { $match: { age: { $gt: 18 } } },
  { $group: { _id: "$name", count: { $sum: 1 } } },
  { $sort: { count: -1 } },
  { $limit: 10 }
])
```
上面的聚合管道将选择名称和年龄字段，然后筛选出年龄大于18岁的文档。接下来，它将按名称对文档进行分组，并计算每个组中文档的数量。然后，它将按文档数量对组进行降序排序，并限制输出文档的数量为10个。
