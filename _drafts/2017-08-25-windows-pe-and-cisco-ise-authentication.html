---
layout: post
title: Windows PE  and Cisco ISE authentication 802.1x
date: '2017-08-25T03:19:00.000-07:00'
author: syswow64
tags:
- 802.1x
- security
- SCCM
- Cisco ISE
- NExt Generation Network
- WinPE ISE
modified_time: '2020-01-17T04:20:27.098-08:00'
blogger_id: tag:blogger.com,1999:blog-4452544758446808584.post-1037390243563294734
blogger_orig_url: https://www.syswow64.co.uk/2017/08/windows-pe-and-cisco-ise-authentication.html
---

<h2>Windows PE &nbsp;and Cisco ISE authentication</h2>This blog entry is intended to assist you when implementing a Cisco ISE next generation network across the organisation. &nbsp;Without ISE profiles the SCCM Task Sequence will fail to connect to Distribution Points and the MDT database. &nbsp;UNC paths are blocked and network access is restricted.<br />Cisco ISE by design will restrict network access to prevent unauthorized clients from simply plugging their equipment into the network and being routed like a authorised client.<br />Computer and User Authentication (explain in detailed section)<br />Cisco ISE profiles should be implemented in two ways; Cisco ISE profiles via Group Policy for domain joined systems, and to bake ISE profiles into the SCCM Boot Image. &nbsp;The guide below will explain how to implement both configuration setups.<br /><div><br /></div><br /><h2>Tutorial - WinPE</h2><div>Microsoft has detailed the two XML files required to achieve User Authentication when in WinPE <a href="https://docs.microsoft.com/en-gb/windows-hardware/manufacture/desktop/winpe-network-drivers-initializing-and-adding-drivers" target="_blank">here</a></div><div><br /></div><div>Create an XML called "EthernetLANProfile.xml" containing the following. The Thumb Print detailed within &lt;TrustedRootCA&gt; should reflect a trusted Third Party Cert; This ISE certification should also be deployed to all Domain Joined systems for GPO ISE Profiles (see below Tutorial - OS)<br /><br />&lt;?xml version="1.0"?&gt;<br />&lt;!-- Sample LAN profile: EthernetLANProfile.xml" --&gt;<br />&lt;LANProfile xmlns="http://www.microsoft.com/networking/LAN/profile/v1"&gt;<br />&nbsp; &lt;MSM&gt;<br />&nbsp; &nbsp; &lt;security&gt;<br />&nbsp; &nbsp; &nbsp; &lt;OneXEnforced&gt;false&lt;/OneXEnforced&gt;<br />&nbsp; &nbsp; &nbsp; &lt;OneXEnabled&gt;true&lt;/OneXEnabled&gt;<br />&nbsp; &nbsp; &nbsp; &lt;OneX xmlns="http://www.microsoft.com/networking/OneX/v1"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;cacheUserData&gt;true&lt;/cacheUserData&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; <b>&lt;authMode&gt;user&lt;/authMode&gt;</b><br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;EAPConfig&gt;&lt;EapHostConfig<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/EapHostConfig"&gt;&lt;EapMethod&gt;&lt;Type<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/EapCommon"&gt;25&lt;/Type&gt;&lt;VendorId<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/EapCommon"&gt;0&lt;/VendorId&gt;&lt;VendorType<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/EapCommon"&gt;0&lt;/VendorType&gt;&lt;AuthorId<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/EapCommon"&gt;0&lt;/AuthorId&gt;&lt;/EapMethod&gt;&lt;Config<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/EapHostConfig"&gt;&lt;Eap<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/BaseEapConnectionPropertiesV1"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;Type&gt;25&lt;/Type&gt;&lt;EapType<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV1"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;ServerValidation&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;DisableUserPromptForServerValidation&gt;false&lt;/DisableUserPromptForServerValidation&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;ServerNames&gt;&lt;/ServerNames&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <b>&lt;TrustedRootCA&gt;</b><span style="font-size: x-small;">1a 2b 3c 4d 56 78 90 aa bb cc dd ee ff 1a 2b 3c 4d 5e 6f</span><b>&lt;/TrustedRootCA&gt;</b><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/ServerValidation&gt;&lt;FastReconnect&gt;true&lt;/FastReconnect&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;InnerEapOptional&gt;false&lt;/InnerEapOptional&gt;&lt;Eap<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/BaseEapConnectionPropertiesV1"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;Type&gt;26&lt;/Type&gt;&lt;EapType<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/MsChapV2ConnectionPropertiesV1"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;UseWinLogonCredentials&gt;false&lt;/UseWinLogonCredentials&gt;&lt;/EapType&gt;&lt;/Eap&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;EnableQuarantineChecks&gt;false&lt;/EnableQuarantineChecks&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;RequireCryptoBinding&gt;false&lt;/RequireCryptoBinding&gt;&lt;PeapExtensions&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;PerformServerValidation<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV2"&gt;false<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/PerformServerValidation&gt;&lt;AcceptServerName<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV2"&gt;false<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/AcceptServerName&gt;&lt;PeapExtensionsV2<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV2"&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;AllowPromptingWhenServerCANotFound<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xmlns="http://www.microsoft.com/provisioning/MsPeapConnectionPropertiesV3"&gt;true<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/AllowPromptingWhenServerCANotFound&gt;&lt;/PeapExtensionsV2&gt;&lt;/PeapExtensions&gt;&lt;/EapType&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;/Eap&gt;&lt;/Config&gt;&lt;/EapHostConfig&gt;&lt;/EAPConfig&gt;<br />&nbsp; &nbsp; &nbsp; &lt;/OneX&gt;<br />&nbsp; &nbsp; &lt;/security&gt;<br />&nbsp; &lt;/MSM&gt;<br />&lt;/LANProfile&gt;<br /><br /><br /><br /></div><div>Create another XML file called "<span style="background-color: #f9f9f9; color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif; font-size: 14px; white-space: pre;">EAP_UserData.xml" containing the Service Account User Credentials.</span></div><div><span style="background-color: #f9f9f9; color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif; font-size: 14px; white-space: pre;"><br /></span></div><div><span style="background-color: #f9f9f9; font-size: 14px; white-space: pre;"><span style="color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif;">&lt;?xml version="1.0"?&gt; &lt;!-- Sample EAP user data: EAP_UserData.xml" --&gt; &lt;EapHostUserCredentials    xmlns="http://www.microsoft.com/provisioning/EapHostUserCredentials"    xmlns:eapCommon="http://www.microsoft.com/provisioning/EapCommon"    xmlns:baseEap="http://www.microsoft.com/provisioning/BaseEapMethodUserCredentials"&gt;   &lt;EapMethod&gt;     &lt;eapCommon:Type&gt;25&lt;/eapCommon:Type&gt;     &lt;eapCommon:AuthorId&gt;0&lt;/eapCommon:AuthorId&gt;   &lt;/EapMethod&gt;   &lt;Credentials     xmlns:eapUser="http://www.microsoft.com/provisioning/EapUserPropertiesV1"      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"      xmlns:baseEap="http://www.microsoft.com/provisioning/BaseEapUserPropertiesV1"      xmlns:MsPeap="http://www.microsoft.com/provisioning/MsPeapUserPropertiesV1"      xmlns:MsChapV2="http://www.microsoft.com/provisioning/MsChapV2UserPropertiesV1"&gt;     &lt;baseEap:Eap&gt;       &lt;baseEap:Type&gt;25&lt;/baseEap:Type&gt;       &lt;MsPeap:EapType&gt;         &lt;MsPeap:RoutingIdentity&gt;onex\administrator&lt;/MsPeap:RoutingIdentity&gt;         &lt;baseEap:Eap&gt;           &lt;baseEap:Type&gt;26&lt;/baseEap:Type&gt;           &lt;MsChapV2:EapType&gt;             <b>&lt;MsChapV2:Username&gt;SVC-Account-Name&lt;/MsChapV2:Username&gt;             &lt;MsChapV2:Password&gt;</b></span></span><b><span style="background-color: #f9f9f9; color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif; font-size: 14px; white-space: pre;">SVC-Account-</span><span style="background-color: #f9f9f9; color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif; font-size: 14px; white-space: pre;">password&lt;/MsChapV2:Password&gt;</span></b></div><div><b><span style="background-color: #f9f9f9; font-size: 14px; white-space: pre;"><span style="color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif;">            &lt;MsChapV2:LogonDomain&gt;</span></span><span style="background-color: #f9f9f9; color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif; font-size: 14px; white-space: pre;">SVC-Account-Domain</span><span style="background-color: #f9f9f9; color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif; font-size: 14px; white-space: pre;">&lt;/MsChapV2:LogonDomain&gt;</span></b></div><div><span style="background-color: #f9f9f9; font-size: 14px; white-space: pre;"><span style="color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif;"><b>          </b>&lt;/MsChapV2:EapType&gt;         &lt;/baseEap:Eap&gt;       &lt;/MsPeap:EapType&gt;     &lt;/baseEap:Eap&gt;   &lt;/Credentials&gt; </span><span style="color: #222222; font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">&lt;/EapHostUserCredentials&gt;</span></span></div><div><span style="background-color: #f9f9f9; font-size: 14px; white-space: pre;"><span style="color: #222222; font-family: &quot;consolas&quot; , &quot;menlo&quot; , &quot;monaco&quot; , &quot;lucida console&quot; , &quot;liberation mono&quot; , &quot;dejavu sans mono&quot; , &quot;bitstream vera sans mono&quot; , &quot;courier new&quot; , monospace , sans-serif;"><br /></span></span></div><div><br /></div>The SCCM Boot image will need to contain the WinPE-Dot3Svc Optional Component. &nbsp;However, from my experience this component doesnt work in Windows 10 version 1607 or 1703.<br />The component wizard completes without errors however, the Dot3Svc cannot start in WinPE. Micrsoft have detailed the issue <a href="https://support.microsoft.com/en-gb/help/4025632/windows-pe-network-winpe-dot3svc-optional-component-doesn-t-work-in-wi" target="_blank">here</a><br /><br />The component will need to be manually installed; download the KB4025632 MSU file from Windows Update Catalog- ## https://www.catalog.update.microsoft.com/Search.aspx?q=KB4025632<br /><br />The following two command will mount the Boot.wim Image and inject the Dot3Svc component.<br /><br />Dism /Mount-Image /ImageFile:"C:\temp\WinPEx64\sources\boot.wim" /index:1 /MountDir:"C:\temp\WinPE_amd64-mount"<br /><br />Dism /Add-Package /Image:"C:\temp\WinPE_amd64-mount" /PackagePath:"C:\temp\WinPEx64\windows10.0-kb4025632-x64_af86717e4eec306948b23cd1e82ff95640e51f5e.msu"<br /><br />Before the Boot image is dismounted and copied to SCCM we also need to bake the ISE XML profiles into the Boot image.<br /><br />Copy the EthernetLANProfile.xml&nbsp;&amp; EAP_UserData.xml created earlier into the folder &nbsp;"windows\system32"<br /><br /><b>C:\temp\WinPE_amd64-mount\windows\system32\</b><br /><br />Dism /Unmount-Image /MountDir:"C:\temp\WinPE_amd64-mount" /commit<br /><br />After installing the component copy the wim to your Boot image source location.<br />Add a custom prestart command. &nbsp;Open the Properties of the Boot image and go to the customization tab, enable the prestart command and type the following three commands (enable Dot3svc, import Ethernet Profile , import User Auth Profile"<br /><br />cmd /c powershell -noninteractive -command net start dot3svc &amp; cmd /c netsh lan add profile filename=%SYSTEMDRIVE%\windows\system32\EthernetLANProfile.xml interface=* &nbsp;&amp; cmd /c netsh lan set eapuserdata filename="%SYSTEMDRIVE%\windows\system32\EAP_UserData.xml" alluser=yes Interface=*<br /><br /><br />&nbsp;Within the SCCM console update the distribution point to inject the SCCM binaries and distribute the WIM to your PXE enabled distribution Points.<br /><br />Once the Boot image is loaded and you have typed your WinPE password (if present) the Prestart command will launch (Custom Hook). &nbsp;WinPE will run the commands in the TSConfig.ini file located on the root of the X drive.<br /><br />Before the list of Task Sequences (if available) are presented you will see a command window appear starting the dot3svc service and configure the User Authentication ISE profiles created earlier.<br /><br />If you wanted to check that ISE is running before kicking off the Task Sequence then you can:-<br /><br />Hit F8 for a command prompt (if enabled in the boot image)<br />Type:<br /><b>&nbsp;PowerShell -command Get-Service dot3svc&nbsp;</b><br /><br />You should see the service status as running<br /><br />Running &nbsp; &nbsp; &nbsp; dot3svc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Wired AutoConfig<br /><div><br /></div><ul></ul><br /><br /><div><br /></div><br />